<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AWARE – live monitoring (Kessel-Lo, Belgium)</title>
  <style>
    :root { --fg:#0f172a; --muted:#64748b; --card:#f1f5f9; }
    body { margin:0; font:16px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; color:var(--fg); }
    .wrap { max-width:1100px; margin:40px auto; padding:0 16px; }
    h1 { margin:0 0 6px; font-size:32px; }
    p.sub { margin:0 0 20px; color:var(--muted); }
    #error { color:#b91c1c; margin:8px 0 12px; min-height:1.2em; }
    .grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:14px; margin:12px 0 18px; }
    .card { background:var(--card); border-radius:12px; padding:16px; }
    .k { font-size:13px; color:var(--muted); }
    .v { margin-top:10px; font-size:28px; font-weight:600; }
    .row { display:flex; gap:12px; align-items:center; margin-top:10px; }
    select,button { font:inherit; padding:8px 10px; border-radius:10px; border:1px solid #cbd5e1; background:#fff; }
    canvas { width:100%; height:340px; }
  </style>

  <!-- libs -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script>
</head>
<body>
  <div class="wrap">
    <h1>andesaware – live weather</h1>
    <p class="sub">real-time feed from your ecowitt station (si units)</p>

    <div id="error"></div>

    <div class="grid">
      <div class="card"><div class="k">Temperature</div><div class="v" id="card-temp">—</div></div>
      <div class="card"><div class="k">Humidity</div><div class="v" id="card-rh">—</div></div>
      <div class="card"><div class="k">Pressure</div><div class="v" id="card-pres">—</div></div>
      <div class="card"><div class="k">Wind</div><div class="v" id="card-wind">—</div></div>
      <div class="card"><div class="k">Rain rate</div><div class="v" id="card-rain">—</div></div>
      <div class="card"><div class="k">Solar</div><div class="v" id="card-solar">—</div></div>
      <div class="card"><div class="k">UV index</div><div class="v" id="card-uv">—</div></div>
    </div>

    <canvas id="chart"></canvas>

    <div class="row">
      <label for="hours">history window:</label>
      <select id="hours">
        <option value="6">6 h</option>
        <option value="12">12 h</option>
        <option value="24" selected>24 h</option>
        <option value="48">48 h</option>
        <option value="168">7 d</option>
      </select>
      <button id="refresh" type="button">refresh</button>
    </div>
  </div>

  <script>
  const ORIGIN = 'https://api.andesaware.com';

  const $err   = document.getElementById('error');
  const $hours = document.getElementById('hours');
  const $btn   = document.getElementById('refresh');
  const $      = (id) => document.getElementById(id);

  function setText(id, text) { $(id).textContent = text ?? '—'; }
  function fmtNum(v, d=1, tail='') {
    if (v==null || Number.isNaN(v)) return '—';
    return `${Number(v).toFixed(d)}${tail}`;
  }

  async function getJSON(url) {
    const r = await fetch(url, { cache:'no-store' });
    if (!r.ok) throw new Error(await r.text());
    return r.json();
  }

  // destroy-safe charting
  function renderChart(series) {
    const canvas = document.getElementById('chart');
    const exists = Chart.getChart(canvas);
    if (exists) exists.destroy();

    const ctx = canvas.getContext('2d');
    const labels = series.map(p => new Date(p.t));
    const temp   = series.map(p => p.outdoor_temp_c);
    const wind   = series.map(p => p.wind_speed_ms);
    const rain   = series.map(p => p.rain_rate_mm_hr);

    new Chart(ctx, {
      type: 'line',
      data: {
        labels,
        datasets: [
          { label: 'Temp (°C)', data: temp, yAxisID: 'y1' },
          { label: 'Wind (m/s)', data: wind, yAxisID: 'y2' },
          { label: 'Rain rate (mm/h)', data: rain, yAxisID: 'y3' }
        ]
      },
      options: {
        responsive: true,
        interaction: { mode: 'index', intersect: false },
        parsing: false,
        scales: {
          x: { type: 'time', time: { tooltipFormat: 'dd/MM/yyyy HH:mm' } },
          y1: { type: 'linear', position: 'left' },
          y2: { type: 'linear', position: 'right', grid: { drawOnChartArea: false } },
          y3: { type: 'linear', position: 'right', grid: { drawOnChartArea: false }, display: false }
        }
      }
    });
  }

  async function refresh() {
    try {
      $err.textContent = 'loading…';
      const h = Number($hours.value || 24);

      const [latest, hist] = await Promise.all([
        getJSON(`${ORIGIN}/api/latest`),
        getJSON(`${ORIGIN}/api/history?hours=${h}`) // 5-min cadence by default
      ]);

      const d = latest?.data || {};

      setText('card-temp',  fmtNum(d.outdoor_temp_c, 1, ' °C'));
      setText('card-rh',    d.outdoor_humidity_pct!=null ? `${Number(d.outdoor_humidity_pct).toFixed(0)} %` : '—');
      setText('card-pres',  fmtNum(d.pressure_rel_hpa, 1, ' hPa'));
      setText('card-wind',  (d.wind_speed_ms!=null) ? `${Number(d.wind_speed_ms).toFixed(1)} m/s @ ${d.wind_dir_deg ?? '—'}°` : '—');
      setText('card-rain',  fmtNum(d.rain_rate_mm_hr, 2, ' mm/h'));
      setText('card-solar', fmtNum(d.solar_wm2, 0, ' W/m²'));
      setText('card-uv',    (d.uv_index!=null) ? Number(d.uv_index).toFixed(1) : '—');

      renderChart(hist);
      $err.textContent = '';
    } catch (e) {
      console.error(e);
      $err.textContent = `error: ${e.message || e}`;
    }
  }

  // wire once
  document.addEventListener('DOMContentLoaded', () => {
    $btn.addEventListener('click', refresh);
    refresh();
    setInterval(refresh, 60_000); // auto update every minute
  });
  </script>
</body>
</html>
