<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>AWARE – live monitoring</title>
  <meta http-equiv="Cache-Control" content="no-store" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --card: #f5f7fb; --text: #111827; --muted:#6b7280; --border:#e5e7eb; }
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; color: var(--text); }
    .wrap { max-width: 1100px; margin: 32px auto; padding: 0 16px; }
    h1 { font-size: 24px; margin: 0 0 8px 0; }
    .sub { color: var(--muted); margin-bottom: 20px; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(190px,1fr)); gap: 12px; }
    .card { background: var(--card); border: 1px solid var(--border); border-radius: 14px; padding: 14px; }
    .k { font-size: 12px; color: var(--muted); }
    .v { font-size: 26px; font-weight: 600; margin-top: 4px; }
    .row { display:flex; gap:10px; align-items:center; margin: 8px 0 0; color: var(--muted); font-size: 12px; }
    .error { color: #b91c1c; }
    .controls { display:flex; gap:10px; align-items:center; margin: 16px 0; }
    button, select { padding: 8px 10px; border: 1px solid var(--border); border-radius: 10px; background:#fff; cursor:pointer; }
    button:disabled { opacity:.6; cursor:not-allowed;}
    canvas { width:100%; height:320px; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>andesaware – live weather</h1>
    <div class="sub">real-time feed from your ecowitt station (si units)</div>

    <div id="status" class="row">loading…</div>

    <div class="grid" id="cards"></div>

    <div class="controls">
      <label for="hours">history window:</label>
      <select id="hours">
        <option value="6">6 h</option>
        <option value="12">12 h</option>
        <option value="24" selected>24 h</option>
        <option value="48">48 h</option>
        <option value="72">72 h</option>
      </select>
      <button id="refresh">refresh</button>
      <span id="updated" class="row"></span>
    </div>

    <canvas id="chart"></canvas>
  </div>

<!-- libs -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script>

<script>
const ORIGIN = 'https://api.andesaware.com';

let autoTimer = null;

// cache dom
const $err   = document.getElementById('error');
const $hours = document.getElementById('hours');     // your <select id="hours">
const $btn   = document.getElementById('refresh');   // your <button id="refresh">
const $t     = (id) => document.getElementById(id);

// cards helper
function setCard(id, text) { $t(id).textContent = text ?? '—'; }
function n(v, d=1) { return v==null || Number.isNaN(v) ? null : Number(v).toFixed(d); }

// destroy-safe chart render
function renderChart(series) {
  const canvas = document.getElementById('chart');
  const existing = Chart.getChart(canvas);
  if (existing) existing.destroy();

  const ctx = canvas.getContext('2d');
  const labels = series.map(p => new Date(p.t));
  const temp   = series.map(p => p.outdoor_temp_c);
  const wind   = series.map(p => p.wind_speed_ms);
  const rain   = series.map(p => p.rain_rate_mm_hr);

  new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [
        { label: 'Temp (°C)', data: temp, yAxisID: 'y1' },
        { label: 'Wind (m/s)', data: wind, yAxisID: 'y2' },
        { label: 'Rain rate (mm/h)', data: rain, yAxisID: 'y3' }
      ]
    },
    options: {
      responsive: true,
      interaction: { mode: 'index', intersect: false },
      parsing: false,
      scales: {
        x: { type: 'time', time: { tooltipFormat: 'dd/MM/yyyy HH:mm' } },
        y1: { type: 'linear', position: 'left' },
        y2: { type: 'linear', position: 'right', grid: { drawOnChartArea: false } },
        y3: { type: 'linear', position: 'right', grid: { drawOnChartArea: false }, display: false }
      }
    }
  });
}

// data loaders
async function loadLatest() {
  const r = await fetch(`${ORIGIN}/api/latest`, { cache: 'no-store' });
  if (!r.ok) throw new Error(await r.text());
  return r.json();
}
async function loadHistory(h=24) {
  const r = await fetch(`${ORIGIN}/api/history?hours=${h}`, { cache: 'no-store' });
  if (!r.ok) throw new Error(await r.text());
  return r.json();
}

async function refresh() {
  try {
    $err && ($err.textContent = '');
    const hours = Number($hours?.value || 24);
    const [latest, hist] = await Promise.all([loadLatest(), loadHistory(hours)]);
    const d = latest?.data || {};

    // update cards (use your element IDs)
    setCard('card-temp', n(d.outdoor_temp_c));
    setCard('card-rh',   d.outdoor_humidity_pct != null ? `${Number(d.outdoor_humidity_pct).toFixed(0)} %` : '—');
    setCard('card-pres', n(d.pressure_rel_hpa, 1));
    setCard('card-wind', d.wind_speed_ms != null ? `${Number(d.wind_speed_ms).toFixed(1)} m/s @ ${d.wind_dir_deg ?? '—'}°` : '—');
    setCard('card-rain', n(d.rain_rate_mm_hr, 2));
    setCard('card-solar', n(d.solar_wm2, 0));
    setCard('card-uv', d.uv_index != null ? Number(d.uv_index).toFixed(1) : '—');

    // line chart
    renderChart(hist);
  } catch (e) {
    console.error(e);
    $err && ($err.textContent = `error: ${e.message || e}`);
  }
}

// wire UI once
document.addEventListener('DOMContentLoaded', () => {
  $btn?.addEventListener('click', () => refresh());
  refresh();                         // initial
  clearInterval(autoTimer);
  autoTimer = setInterval(refresh, 60_000); // refresh every 60 s
});
</script>

</body>
</html>
