<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>andesaware – live weather</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  body { font-family: system-ui, sans-serif; margin: 20px; background: #fafafa; }
  h1 { margin-top: 0; }
  .tiles { display: grid; grid-template-columns: repeat(auto-fit,minmax(180px,1fr)); gap: 12px; margin-bottom: 25px; }
  .tile { background: white; padding: 14px 16px; border-radius: 8px; box-shadow: 0 1px 4px rgba(0,0,0,0.08); }
  .tile-label { font-size: 13px; color: #555; margin-bottom: 6px; }
  .tile-value { font-size: 22px; font-weight: 600; }
  .controls { margin: 20px 0; display: flex; gap: 10px; align-items: center; }
  select, button { padding: 6px 10px; font-size: 15px; }
  canvas { max-width: 100%; margin-bottom: 40px; }
  #err { color: red; margin-bottom: 10px; }
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
</head>
<body>

<h1>AW001 – live data</h1>
<p>real-time feed from your station (si units)</p>
<div id="err"></div>

<div class="tiles" id="tiles">
  <!-- tiles filled by JS -->
</div>

<div class="controls">
  <span>history window:</span>
  <select id="range">
    <option value="1">1 h</option>
    <option value="6">6 h</option>
    <option value="12">12 h</option>
    <option value="24" selected>24 h</option>
    <option value="48">48 h</option>
    <option value="168">7 d</option>
    <option value="all">all</option>
  </select>
  <button id="refresh">refresh</button>
  <a id="csv" href="#" download>download csv</a>
</div>

<canvas id="chart-temp"></canvas>
<canvas id="chart-press"></canvas>
<canvas id="chart-wind"></canvas>
<canvas id="chart-rain"></canvas>
<canvas id="chart-solar"></canvas>
<canvas id="chart-uv"></canvas>

<script>
const API = "https://api.andesaware.com";
let charts = {}; // hold Chart.js objects

// --- helpers ---
const fmt = (v, unit="") => v == null ? "—" : `${Number(v).toFixed(1)}${unit}`;
const fetchJSON = (u) => fetch(u).then(r => r.json());

function showError(msg){ document.getElementById("err").textContent = msg || ""; }

// --- live tiles ---
async function loadLatest(){
  try {
    const j = await fetchJSON(`${API}/api/latest`);
    const d = j.data || {};
    const T = [
      ["Temperature", fmt(d.outdoor_temp_c," °C")],
      ["Humidity", fmt(d.outdoor_humidity_pct," %")],
      ["Pressure (rel)", fmt(d.pressure_rel_hpa," hPa")],
      ["Wind", d.wind_speed_ms!=null?`${d.wind_speed_ms.toFixed(1)} m/s @ ${d.wind_dir_deg}°`:"—"],
      ["Gust", fmt(d.wind_gust_ms," m/s")],
      ["Rain rate", fmt(d.rain_rate_mm_hr," mm/h")],
      ["Hourly rain", fmt(d.rain_hourly_mm," mm")],
      ["Daily rain", fmt(d.rain_daily_mm," mm")],
      ["Solar", fmt(d.solar_wm2," W/m²")],
      ["UV index", d.uv_index ?? "—"]
    ];
    const div = document.getElementById("tiles");
    div.innerHTML = T.map(([l,v]) =>
      `<div class="tile"><div class="tile-label">${l}</div><div class="tile-value">${v}</div></div>`
    ).join("");
  } catch(e){ showError("error loading latest"); }
}

// --- charts ---
function destroyAllCharts(){
  for(const k in charts){ charts[k].destroy(); }
  charts = {};
}

async function loadHistory(){
  showError("");
  destroyAllCharts();
  const h = document.getElementById("range").value;
  const url = h==="all" ? `${API}/api/history?hours=99999` :
                          `${API}/api/history?hours=${h}`;
  document.getElementById("csv").href = h==="all"
      ? `${API}/api/export.csv?hours=99999`
      : `${API}/api/export.csv?hours=${h}`;

  const rows = await fetchJSON(url);
  if(!rows.length){ showError("no data in range"); return; }

  const t = rows.map(r => new Date(r.t));
  const pick = (k) => rows.map(r => r[k]);

  makeChart("chart-temp","Temperature (°C)", t, pick("outdoor_temp_c"));
  makeChart("chart-press","Pressure (hPa)", t, pick("pressure_rel_hpa"));
  makeChart("chart-wind","Wind (m/s)", t, [
      {label:"speed", data: pick("wind_speed_ms")},
      {label:"gust", data: pick("wind_gust_ms")}
  ]);
  makeChart("chart-rain","Rain (mm / mm/h)", t, [
      {label:"rate mm/h", data: pick("rain_rate_mm_hr")},
      {label:"hourly mm", data: pick("rain_hourly_mm")},
      {label:"daily mm", data: pick("rain_daily_mm")}
  ]);
  makeChart("chart-solar","Solar (W/m²)", t, pick("solar_wm2"));
  makeChart("chart-uv","UV index", t, pick("uv_index"));
}

function makeChart(id,label,x,series){
  const ctx = document.getElementById(id).getContext("2d");
  const ds = Array.isArray(series)
    ? series.map(s => ({ label:s.label, data:s.data, borderWidth:1 }))
    : [{ label, data:series, borderWidth:1 }];

  charts[id] = new Chart(ctx,{
    type:"line",
    data:{ labels:x, datasets:ds },
    options:{
      responsive:true,
      interaction:{ mode:"nearest", intersect:false },
      scales:{ x:{ type:"time", time:{ unit:"hour" } } }
    }
  });
}

// --- init ---
document.getElementById("refresh").onclick = () => { loadLatest(); loadHistory(); };
loadLatest();
loadHistory();

// auto refresh every 5 min
setInterval(() => { loadLatest(); }, 300000);
</script>
</body>
</html>
