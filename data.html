<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>andesaware — live weather</title>
  <style>
    :root { --bg:#0b1220; --fg:#0e141b; --card:#f6f7fb; --muted:#6b7280; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif;
           line-height:1.4; color:#111; background:#fff; }
    header { padding:28px 20px 8px; max-width:1040px; margin:0 auto; }
    h1 { margin:0 0 6px; font-size:32px; }
    p.lead { margin:0; color:#4b5563; }
    main { padding:16px 20px 40px; max-width:1040px; margin:0 auto; }
    #error { color:#b91c1c; margin:10px 0 0; font-size:14px; min-height:1.2em; }
    .cards { display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:14px; margin:16px 0 22px; }
    .card { background:#f6f7fb; border:1px solid #e5e7eb; border-radius:14px; padding:14px 16px; }
    .card h3 { margin:0 0 10px; font-size:14px; color:#374151; font-weight:600; }
    .value { font-size:28px; font-weight:700; letter-spacing:-0.01em; }
    .sub { font-size:12px; color:#6b7280; margin-left:6px; font-weight:500; }
    .row { display:flex; align-items:center; gap:10px; margin-top:14px; }
    select, button { font:inherit; padding:6px 10px; border-radius:10px; border:1px solid #d1d5db; background:#fff; }
    button { cursor:pointer; }
    canvas { width:100%; max-width:100%; height:320px; }
    .muted { color:#6b7280; font-size:14px; }
  </style>
</head>
<body>
  <header>
    <h1>andesaware – live weather</h1>
    <p class="lead">real-time feed from your ecowitt station (si units)</p>
    <div id="error"></div>
  </header>

  <main>
    <section class="cards">
      <div class="card">
        <h3>Temperature</h3>
        <div class="value"><span id="v-temp">—</span><span class="sub">°C</span></div>
      </div>
      <div class="card">
        <h3>Humidity</h3>
        <div class="value"><span id="v-rh">—</span><span class="sub">%</span></div>
      </div>
      <div class="card">
        <h3>Pressure</h3>
        <div class="value"><span id="v-pres">—</span><span class="sub">hPa</span></div>
      </div>
      <div class="card">
        <h3>Wind</h3>
        <div class="value"><span id="v-wind">—</span><span class="sub">m/s</span></div>
        <div class="muted" id="v-wdir">—</div>
      </div>
      <div class="card">
        <h3>Rain rate</h3>
        <div class="value"><span id="v-rain">—</span><span class="sub">mm/h</span></div>
      </div>
      <div class="card">
        <h3>Solar</h3>
        <div class="value"><span id="v-solar">—</span><span class="sub">W/m²</span></div>
      </div>
      <div class="card">
        <h3>UV index</h3>
        <div class="value"><span id="v-uv">—</span></div>
      </div>
    </section>

    <section>
      <canvas id="chart"></canvas>
    </section>

    <section class="row">
      <label for="hours" class="muted">history window:</label>
      <select id="hours">
        <option value="6">6 h</option>
        <option value="12">12 h</option>
        <option value="24" selected>24 h</option>
        <option value="48">48 h</option>
        <option value="168">7 d</option>
      </select>
      <button id="btn-refresh">refresh</button>
      <span class="muted" id="last-updated" style="margin-left:8px;"></span>
    </section>
  </main>

  <!-- libs -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script>

  <script>
  const ORIGIN = "https://api.andesaware.com";
  const $ = (id) => document.getElementById(id);

  const setText = (id, v) => { const el = $(id); if (el) el.textContent = v; };
  const fmtNum  = (v, d=1) => (v==null || Number.isNaN(v) ? "—" : Number(v).toFixed(d));

  let refreshTimer = null;

  async function getLatest() {
    const r = await fetch(`${ORIGIN}/api/latest`, { cache: "no-store" });
    if (!r.ok) throw new Error(await r.text());
    return r.json();
  }
  async function getHistory(hours) {
    const r = await fetch(`${ORIGIN}/api/history?hours=${hours}`, { cache: "no-store" });
    if (!r.ok) throw new Error(await r.text());
    return r.json();
  }

  function updateCards(latest) {
    const d = latest?.data || {};
    setText("v-temp", fmtNum(d.outdoor_temp_c, 1));
    setText("v-rh",   d.outdoor_humidity_pct==null ? "—" : Number(d.outdoor_humidity_pct).toFixed(0));
    setText("v-pres", fmtNum(d.pressure_rel_hpa, 1));
    setText("v-wind", fmtNum(d.wind_speed_ms, 1));
    setText("v-wdir", d.wind_dir_deg==null ? "—" : `direction: ${d.wind_dir_deg}°`);
    setText("v-rain", fmtNum(d.rain_rate_mm_hr, 2));
    setText("v-solar", fmtNum(d.solar_wm2, 0));
    setText("v-uv",   d.uv_index==null ? "—" : Number(d.uv_index).toFixed(1));
    setText("last-updated", latest?.ts_local ? `last updated: ${latest.ts_local} UTC` : "");
  }

  function renderChart(series) {
    const canvas = $("chart");
    const old = Chart.getChart(canvas);
    if (old) old.destroy();

    const labels = series.map(p => new Date(p.t));
    const temp   = series.map(p => p.outdoor_temp_c);
    const wind   = series.map(p => p.wind_speed_ms);
    const rain   = series.map(p => p.rain_rate_mm_hr);

    new Chart(canvas.getContext("2d"), {
      type: "line",
      data: {
        labels,
        datasets: [
          { label: "Temp (°C)", data: temp, yAxisID: "y1" },
          { label: "Wind (m/s)", data: wind, yAxisID: "y2" },
          { label: "Rain rate (mm/h)", data: rain, yAxisID: "y3" }
        ]
      },
      options: {
        responsive: true,
        parsing: false,
        interaction: { mode: "index", intersect: false },
        scales: {
          x: { type: "time", time: { tooltipFormat: "dd/MM/yyyy HH:mm" } },
          y1: { type: "linear", position: "left" },
          y2: { type: "linear", position: "right", grid: { drawOnChartArea:false } },
          y3: { type: "linear", position: "right", display:false, grid: { drawOnChartArea:false } }
        }
      }
    });
  }

  async function refresh() {
    try {
      setText("error", "loading…");
      const hours = Number($("hours").value || 24);
      const [latest, history] = await Promise.all([getLatest(), getHistory(hours)]);
      updateCards(latest);
      renderChart(history);
      setText("error", "");
    } catch (e) {
      console.error(e);
      setText("error", `error: ${e.message || e}`);
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    $("btn-refresh").addEventListener("click", refresh);
    refresh();
    if (refreshTimer) clearInterval(refreshTimer);
    refreshTimer = setInterval(refresh, 60_000); // 1-minute auto refresh
  });
  </script>
</body>
</html>
