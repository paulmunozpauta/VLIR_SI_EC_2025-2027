<!doctype html>
<html lang="en">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>live weather</title>
<style>
  :root { font-family: system-ui, sans-serif; line-height: 1.35; }
  body { margin: 2rem; max-width: 48rem; }
  .grid { display: grid; grid-template-columns: 14rem 1fr; gap: .35rem .75rem; }
  .k { color: #444; }
  .v { font-variant-numeric: tabular-nums; }
  .muted { color:#666; font-size:.9rem; margin-top:.75rem }
  .ok { color:#2c7; } .err{ color:#c33; }
</style>

<h1>aware weather</h1>
<div id="status" class="muted">loading…</div>
<dl class="grid" id="out"></dl>

<script>
const ENDPOINT = "https://api.andesaware.com/weatherstation/latest"; // worker read route
const REFRESH_MS = 30000;

function fToC(f){ return (f - 32) * 5/9; }
function mphToMs(m){ return m * 0.44704; }
function inHgToHpa(i){ return i * 33.8638866667; }
function inToMm(i){ return i * 25.4; }

function row(k, v){ return `<dt class="k">${k}</dt><dd class="v">${v}</dd>`; }

async function load(){
  const status = document.getElementById('status');
  try {
    const res = await fetch(ENDPOINT, { cache: 'no-store' });
    if (!res.ok) throw new Error(`http ${res.status}`);
    const data = await res.json();
    const g = data.wu_raw || {};

    // parse numbers safely
    const n = (x) => x==null ? null : Number(x);
    const tempF = n(g.tempf), dewF = n(g.dewptf), humid = n(g.humidity);
    const pressInHg = n(g.baromin), windMph = n(g.windspeedmph), gustMph = n(g.windgustmph);
    const rainIn = n(g.rainin), dayRainIn = n(g.dailyrainin);
    const solar = n(g.solarradiation), uv = n(g.UV), wdir = n(g.winddir);

    const rows = [
      row('time (utc)', g.dateutc ?? '—'),
      row('temperature', `${tempF ?? '—'} °F (${tempF!=null ? fToC(tempF).toFixed(1) : '—'} °C)`),
      row('dew point', `${dewF ?? '—'} °F (${dewF!=null ? fToC(dewF).toFixed(1) : '—'} °C)`),
      row('humidity', `${humid ?? '—'} %`),
      row('pressure', `${pressInHg ?? '—'} inHg (${pressInHg!=null ? inHgToHpa(pressInHg).toFixed(1) : '—'} hPa)`),
      row('wind', `${windMph ?? '—'} mph (${windMph!=null ? mphToMs(windMph).toFixed(1) : '—'} m/s) dir ${wdir ?? '—'}°`),
      row('gust', `${gustMph ?? '—'} mph (${gustMph!=null ? mphToMs(gustMph).toFixed(1) : '—'} m/s)`),
      row('rain (interval)', `${rainIn ?? '—'} in (${rainIn!=null ? inToMm(rainIn).toFixed(2) : '—'} mm)`),
      row('rain (today)', `${dayRainIn ?? '—'} in (${dayRainIn!=null ? inToMm(dayRainIn).toFixed(1) : '—'} mm)`),
      row('solar', `${solar ?? '—'} W/m²`),
      row('uv', uv ?? '—'),
      row('received', data.wu_raw?.received_at ?? '—'),
      row('station id', g.ID ?? '—'),
    ];

    document.getElementById('out').innerHTML = rows.join('');
    status.textContent = `updated ${new Date().toLocaleTimeString()} • refresh ${REFRESH_MS/1000}s`;
    status.className = "muted ok";
  } catch (e) {
    document.getElementById('status').textContent = `failed to load (${e.message}). retrying…`;
    document.getElementById('status').className = "muted err";
  }
}
load();
setInterval(load, REFRESH_MS);
</script>
</html>
