<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AW001 (Kessel-Lo) – live data</title>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <style>
    :root { --fg:#0f172a; --muted:#6b7280; --card:#f3f4f6; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; color:var(--fg); margin:24px; }
    h1 { font-size: 1.6rem; margin: 0 0 4px; }
    .sub { color: var(--muted); margin-bottom: 18px; font-size: .95rem; }
    .error { color:#b91c1c; margin: 8px 0 16px; }
    .grid { display:grid; gap:14px; grid-template-columns: repeat(auto-fit,minmax(220px,1fr)); margin-bottom: 18px; }
    .card { background:var(--card); border-radius:16px; padding:14px 16px; }
    .k { font-size:.9rem; color:var(--muted); }
    .v { font-size: 1.25rem; font-weight:600; margin-top: 6px; }
    .toolbar { display:flex; gap:12px; align-items:center; margin: 4px 0 12px; }
    button, select, a.btn { font: inherit; padding:8px 12px; border-radius:10px; border:1px solid #e5e7eb; background:#fff; cursor:pointer; text-decoration:none; color:inherit; }
    .table { width:100%; border-collapse: collapse; margin-top: 10px; }
    .table th, .table td { padding:8px 10px; border-bottom:1px solid #e5e7eb; text-align:right; white-space:nowrap; }
    .table th:first-child, .table td:first-child { text-align:left; }
    .pill { font-variant-numeric: tabular-nums; }
    canvas { width:100%; height:300px; }
  </style>
</head>
<body>
  <h1 id="station-name">AW001 (Kessel-Lo) – live data</h1>
  <div class="sub">
    <span id="updated">updated: —</span>
    · <a id="csv" class="btn" href="https://api.andesaware.com/api/export.csv?hours=24">download csv</a>
  </div>
  <div id="err" class="error" hidden></div>

  <div class="grid" id="cards">
    <div class="card"><div class="k">Temperature</div><div class="v" id="temp">—</div></div>
    <div class="card"><div class="k">Humidity</div><div class="v" id="rh">—</div></div>
    <div class="card"><div class="k">Indoor Temp</div><div class="v" id="temp_in">—</div></div>
    <div class="card"><div class="k">Indoor Humidity</div><div class="v" id="rh_in">—</div></div>
    <div class="card"><div class="k">Pressure (rel)</div><div class="v" id="presrel">—</div></div>
    <div class="card"><div class="k">Pressure (abs)</div><div class="v" id="presabs">—</div></div>
    <div class="card"><div class="k">Wind</div><div class="v" id="wind">—</div></div>
    <div class="card"><div class="k">Gust</div><div class="v" id="gust">—</div></div>
    <div class="card"><div class="k">Rain rate</div><div class="v" id="rrate">—</div></div>
    <div class="card"><div class="k">Hourly rain</div><div class="v" id="rhour">—</div></div>
    <div class="card"><div class="k">Daily rain</div><div class="v" id="rdaily">—</div></div>
    <div class="card"><div class="k">Solar</div><div class="v" id="solar">—</div></div>
    <div class="card"><div class="k">UV index</div><div class="v" id="uv">—</div></div>
  </div>

  <div class="toolbar">
    <select id="win">
      <option value="6">6 h</option>
      <option value="12">12 h</option>
      <option selected value="24">24 h</option>
      <option value="48">48 h</option>
      <option value="168">7 d</option>
    </select>
    <button id="refresh">refresh</button>
    <span id="autotext" class="sub"></span>
  </div>

  <canvas id="chart"></canvas>

  <h3>last 24 hours</h3>
  <table class="table" id="table">
    <thead>
      <tr>
        <th>time (utc)</th>
        <th>temp (°C)</th>
        <th>rh (%)</th>
        <th>in temp (°C)</th>
        <th>in rh (%)</th>
        <th>press rel (hPa)</th>
        <th>press abs (hPa)</th>
        <th>wind (m/s)</th>
        <th>gust (m/s)</th>
        <th>dir (°)</th>
        <th>rain rate (mm/h)</th>
        <th>hourly rain (mm)</th>
        <th>daily rain (mm)</th>
        <th>solar (W/m²)</th>
        <th>uv</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1"></script>
  <script>
    const ORIGIN = 'https://api.andesaware.com';
    const AUTO_REFRESH_MS = 60000; // 60 s
    let chart;

    const fmt = (v, unit, digits=1) =>
      (v==null || Number.isNaN(v)) ? '—' : `${Number(v).toFixed(digits)}${unit? ' '+unit : ''}`;

    const $ = (id) => document.getElementById(id);

    async function jget(url) {
      const r = await fetch(url, { cache:'no-store' });
      if (!r.ok) throw new Error(`${r.status} ${r.statusText}`);
      return r.json();
    }

    let timer;
    function schedule() {
      clearInterval(timer);
      timer = setInterval(loadAll, 60_000);  // every minute
    }
    document.addEventListener('visibilitychange', () => {
      if (!document.hidden) loadAll(); // refresh when tab regains focus
    });
    async function loadAll() {
      try {
        const latest = await (await fetch(API('/api/latest'))).json();
        const hist   = await (await fetch(API(`/api/history?hours=${hoursSel.value}`))).json();
        render(latest, hist);
        schedule(); // keep the loop alive
      } catch(e) { showError(e); schedule(); }
    }
    loadAll();


    function renderCards(latest) {
      const d = latest?.data || {};
      $('station-name').textContent = `${d.station_id || 'AW001'} – live data`;

      $('temp').textContent     = fmt(d.outdoor_temp_c, '°C');
      $('rh').textContent       = fmt(d.outdoor_humidity_pct, '%', 0);

      $('temp_in').textContent  = fmt(d.indoor_temp_c, '°C');
      $('rh_in').textContent    = fmt(d.indoor_humidity_pct, '%', 0);

      $('presrel').textContent  = fmt(d.pressure_rel_hpa, 'hPa', 0);
      $('presabs').textContent  = fmt(d.pressure_abs_hpa, 'hPa', 0);

      $('wind').textContent  = (d.wind_speed_ms==null && d.wind_dir_deg==null)
        ? '—' : `${fmt(d.wind_speed_ms,'m/s')} @ ${d.wind_dir_deg ?? '—'}°`;
      $('gust').textContent  = fmt(d.wind_gust_ms, 'm/s');

      $('rrate').textContent = fmt(d.rain_rate_mm_hr, 'mm/h');
      $('rhour').textContent = fmt(d.rain_hourly_mm, 'mm');
      $('rdaily').textContent = fmt(d.rain_daily_mm, 'mm');

      $('solar').textContent = fmt(d.solar_wm2, 'W/m²', 0);
      $('uv').textContent = fmt(d.uv_index, '', 1);

      $('updated').textContent = `updated: ${latest?.ts_local ?? '—'} UTC`;
    }

    function renderTable(series) {
      const tbody = $('table').querySelector('tbody');
      const last24 = series.filter(r => (Date.now()-r.t) <= 24*3600*1000);
      const rows = last24.slice().reverse().map(r => `
        <tr>
          <td>${r.t_local}</td>
          <td>${fmt(r.outdoor_temp_c,'°C')}</td>
          <td>${fmt(r.outdoor_humidity_pct,'%',0)}</td>
          <td>${fmt(r.indoor_temp_c,'°C')}</td>
          <td>${fmt(r.indoor_humidity_pct,'%',0)}</td>
          <td>${fmt(r.pressure_rel_hpa,'hPa',0)}</td>
          <td>${fmt(r.pressure_abs_hpa,'hPa',0)}</td>
          <td>${fmt(r.wind_speed_ms,'')}</td>
          <td>${fmt(r.wind_gust_ms,'')}</td>
          <td>${r.wind_dir_deg ?? '—'}</td>
          <td>${fmt(r.rain_rate_mm_hr,'')}</td>
          <td>${fmt(r.rain_hourly_mm,'')}</td>
          <td>${fmt(r.rain_daily_mm,'')}</td>
          <td>${fmt(r.solar_wm2,'',0)}</td>
          <td>${fmt(r.uv_index,'',0)}</td>
        </tr>`).join('');
      tbody.innerHTML = rows || `<tr><td colspan="15" style="text-align:center;color:#6b7280">no data</td></tr>`;
    }

    function renderChart(series) {
      const points = series
        .map

(p => ({ x:new Date(p.t), y: p.outdoor_temp_c }))
        .filter(p => p.y != null && !Number.isNaN(p.y));

      // avoid Chart.js error when no data
      if (chart) { chart.destroy(); chart = null; }
      if (!points.length) return;

      const ctx = $('chart').getContext('2d');
      chart = new Chart(ctx, {
        type: 'line',
        data: { datasets: [{ label:'Temperature (°C)', data: points, tension:0.25 }] },
        options: {
          parsing: false,
          animation: false,
          responsive: true,
          scales: {
            x: { type:'time', time:{ unit:'hour' } },
            y: { title: { display:true, text:'°C' } }
          },
          plugins: {
            legend: { display: false },
            tooltip: { mode:'index', intersect:false }
          }
        }
      });
    }

    async function refresh() {
      try {
        $('err').hidden = true;
        const hours = Number($('win').value);
        const [latest, hist] = await Promise.all([
          jget(`${ORIGIN}/api/latest`),
          jget(`${ORIGIN}/api/history?hours=${hours}`)
        ]);

        renderCards(latest);
        renderChart(hist);
        renderTable(hist);
      } catch (e) {
        $('err').textContent = `error: ${e.message}`;
        $('err').hidden = false;
      }
    }

    $('refresh').onclick = refresh;
    $('win').onchange = refresh;

    // auto refresh
    function startAuto() {
      refresh();
      $('autotext').textContent = `(auto refresh every ${AUTO_REFRESH_MS/1000}s)`;
      setInterval(refresh, AUTO_REFRESH_MS);
    }
    startAuto();
  </script>
</body>
</html>
