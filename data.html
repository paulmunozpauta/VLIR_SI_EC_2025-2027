<!doctype html>
<html lang="en">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>live weather</title>
<style>
  :root { font-family: system-ui, sans-serif; line-height: 1.35; }
  body { margin: 2rem; max-width: 48rem; }
  .grid { display: grid; grid-template-columns: 14rem 1fr; gap: .35rem .75rem; }
  .k { color: #444; }
  .v { font-variant-numeric: tabular-nums; }
  .muted { color:#666; font-size:.9rem; margin-top:.75rem }
  .ok { color:#2c7; } .err{ color:#c33; }
</style>

<h1>Kessel-Lo</h1>
<div id="status" class="muted">loading…</div>
<dl class="grid" id="out"></dl>

<script>
const ENDPOINT = "https://api.andesaware.com/weatherstation/latest";
const REFRESH_MS = 30000;

function fToC(f){ return (f - 32) * 5/9; }
function mphToMs(m){ return m * 0.44704; }
function inHgToHpa(i){ return i * 33.8638866667; }
function inToMm(i){ return i * 25.4; }

function row(k, v){ return `<dt class="k">${k}</dt><dd class="v">${v}</dd>`; }

async function load(){
  const status = document.getElementById('status');
  try {
    const res = await fetch(ENDPOINT, { cache: 'no-store' });
    if (!res.ok) throw new Error(`http ${res.status}`);
    const data = await res.json();
    const ecowitt = data.ecowitt_api || {};
    
    // Extract values from Ecowitt API structure
    const outdoor = ecowitt.outdoor || {};
    const wind = ecowitt.wind || {};
    const pressure = ecowitt.pressure || {};
    const rainfall = ecowitt.rainfall || {};
    const solar_uvi = ecowitt.solar_and_uvi || {};

    // Get values with fallbacks
    const tempF = outdoor.temperature?.value;
    const humid = outdoor.humidity?.value;
    const dewF = outdoor.dew_point?.value;
    const windMph = wind.wind_speed?.value;
    const gustMph = wind.wind_gust?.value;
    const wdir = wind.wind_direction?.value;
    const pressInHg = pressure.relative?.value;
    const rainIn = rainfall.rain_rate?.value;
    const dayRainIn = rainfall.daily?.value;
    const solar = solar_uvi.solar?.value;
    const uv = solar_uvi.uvi?.value;

    const rows = [
      row('temperature', `${tempF ?? '—'} °F (${tempF ? fToC(parseFloat(tempF)).toFixed(1) : '—'} °C)`),
      row('feels like', `${outdoor.feels_like?.value ?? '—'} °F (${outdoor.feels_like?.value ? fToC(parseFloat(outdoor.feels_like.value)).toFixed(1) : '—'} °C)`),
      row('humidity', `${humid ?? '—'} %`),
      row('dew point', `${dewF ?? '—'} °F (${dewF ? fToC(parseFloat(dewF)).toFixed(1) : '—'} °C)`),
      row('wind', `${windMph ?? '—'} mph (${windMph ? mphToMs(parseFloat(windMph)).toFixed(1) : '—'} m/s) dir ${wdir ?? '—'}°`),
      row('gust', `${gustMph ?? '—'} mph (${gustMph ? mphToMs(parseFloat(gustMph)).toFixed(1) : '—'} m/s)`),
      row('pressure', `${pressInHg ?? '—'} inHg (${pressInHg ? inHgToHpa(parseFloat(pressInHg)).toFixed(1) : '—'} hPa)`),
      row('rain rate', `${rainIn ?? '—'} in/hr (${rainIn ? inToMm(parseFloat(rainIn)).toFixed(2) : '—'} mm/hr)`),
      row('rain today', `${dayRainIn ?? '—'} in (${dayRainIn ? inToMm(parseFloat(dayRainIn)).toFixed(1) : '—'} mm)`),
      row('solar', `${solar ?? '—'} W/m²`),
      row('uv index', uv ?? '—'),
      row('last update', data.received_at ? new Date(data.received_at).toLocaleString() : '—'),
    ];

    // Add indoor data if available
    if (ecowitt.indoor) {
      rows.splice(3, 0, row('indoor temp', `${ecowitt.indoor.temperature?.value ?? '—'} °F (${ecowitt.indoor.temperature?.value ? fToC(parseFloat(ecowitt.indoor.temperature.value)).toFixed(1) : '—'} °C)`));
      rows.splice(4, 0, row('indoor humidity', `${ecowitt.indoor.humidity?.value ?? '—'} %`));
    }

    document.getElementById('out').innerHTML = rows.join('');
    status.textContent = `updated ${new Date().toLocaleTimeString()} • refresh ${REFRESH_MS/1000}s`;
    status.className = "muted ok";
  } catch (e) {
    document.getElementById('status').textContent = `failed to load (${e.message}). retrying…`;
    document.getElementById('status').className = "muted err";
  }
}
load();
setInterval(load, REFRESH_MS);
</script>
</html>