<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>AndesAware – Live Weather</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{--border:#e5e7eb;--muted:#6b7280;--bg:#f9fafb}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif;line-height:1.45;margin:0;padding:20px;background:#fff;color:#111}
    h2{font-size:28px;margin:8px 0 2px}
    .wrap{max-width:1100px;margin:auto}
    .grid{display:grid;gap:12px}
    .cards{grid-template-columns:repeat(auto-fit,minmax(220px,1fr));margin:10px 0 14px}
    .card{padding:12px;border:1px solid var(--border);border-radius:12px;background:var(--bg)}
    .card .k{font-size:12px;color:var(--muted)}
    .card .v{font-size:22px;font-weight:600}
    .ctrls{display:flex;gap:10px;align-items:center;margin:8px 0 14px}
    .ctrls > * {font-size:14px}
    .err{display:none;color:#b91c1c;margin:6px 0}
    table{width:100%;border-collapse:collapse;font-size:14px}
    thead{background:#f7f7f7}
    th,td{padding:6px 8px;border-top:1px solid var(--border);text-align:center}
    th:first-child,td:first-child{text-align:left}
    .scroll{overflow:auto;border:1px solid var(--border);border-radius:10px}
    .charts{grid-template-columns:1fr;gap:16px}
    button,select{padding:6px 10px;border:1px solid var(--border);border-radius:8px;background:#fff}
    a{color:#0b62d6;text-decoration:none}
  </style>
</head>
<body>
<div class="wrap">
  <h2>andesaware – live weather</h2>
  <p style="margin:0 0 10px;color:#555">real-time feed from your station (si units)</p>

  <div id="aw-error" class="err"></div>

  <!-- CARDS -->
  <div id="aw-cards" class="grid cards"></div>

  <!-- CONTROLS -->
  <div class="ctrls">
    <label for="aw-window">history window:</label>
    <select id="aw-window">
      <option value="6">6 h</option>
      <option value="24" selected>24 h</option>
      <option value="72">72 h</option>
      <option value="168">7 d</option>
    </select>
    <button id="aw-refresh" type="button">refresh</button>
    <a id="aw-csv" href="#" download style="margin-left:auto">download csv</a>
  </div>

  <!-- CHARTS -->
  <div class="grid charts">
    <canvas id="aw-chart-temp" height="110"></canvas>
    <canvas id="aw-chart-wind" height="110"></canvas>
    <canvas id="aw-chart-rain" height="110"></canvas>
  </div>

  <!-- TABLE -->
  <h3 style="margin:16px 0 8px">history</h3>
  <div class="scroll">
    <table id="aw-table">
      <thead>
        <tr>
          <th>time (utc)</th>
          <th>temp (°C)</th>
          <th>rh (%)</th>
          <th>press rel (hPa)</th>
          <th>press abs (hPa)</th>
          <th>wind (m/s)</th>
          <th>gust (m/s)</th>
          <th>dir (°)</th>
          <th>rain rate (mm/h)</th>
          <th>hourly rain (mm)</th>
          <th>daily rain (mm)</th>
          <th>solar (W/m²)</th>
          <th>uv</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<!-- libs -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
<script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1"></script>

<script>
const ORIGIN = 'https://api.andesaware.com';
const $err   = document.getElementById('aw-error');
const $cards = document.getElementById('aw-cards');
const $win   = document.getElementById('aw-window');
const $csv   = document.getElementById('aw-csv');
const $tbody = document.querySelector('#aw-table tbody');

let cTemp, cWind, cRain;

const fmtNum = (n, u='') => (n==null || isNaN(n)) ? '—' : `${Number(n).toFixed(1)}${u? ' '+u: ''}`;
const tlabel = (ms) => luxon.DateTime.fromMillis(ms,{zone:'utc'}).toFormat('dd/LL/yyyy HH:mm');
const api = async (path) => {
  const r = await fetch(path, { cache: 'no-store' });
  if (!r.ok) throw new Error(await r.text());
  return r.json();
};

function renderCards(latest) {
  const d = latest?.data || {};
  const items = [
    ['Temperature', fmtNum(d.outdoor_temp_c,'°C')],
    ['Humidity', d.outdoor_humidity_pct ?? '—'],
    ['Pressure (rel)', fmtNum(d.pressure_rel_hpa,'hPa')],
    ['Pressure (abs)', fmtNum(d.pressure_abs_hpa,'hPa')],
    ['Wind', (d.wind_speed_ms!=null||d.wind_dir_deg!=null) ? `${fmtNum(d.wind_speed_ms,'m/s')} @ ${d.wind_dir_deg??'—'}°` : '—'],
    ['Gust', fmtNum(d.wind_gust_ms,'m/s')],
    ['Rain rate', fmtNum(d.rain_rate_mm_hr,'mm/h')],
    ['Hourly rain', fmtNum(d.rain_hourly_mm,'mm')],
    ['Daily rain', fmtNum(d.rain_daily_mm,'mm')],
    ['Solar', fmtNum(d.solar_wm2,'W/m²')],
    ['UV index', d.uv_index ?? '—'],
    // Indoor (may be null in WU mode)
    ['Indoor temp', fmtNum(d.indoor_temp_c,'°C')],
    ['Indoor RH', d.indoor_humidity_pct ?? '—']
  ];
  $cards.innerHTML = items.map(([k,v]) => `
    <div class="card">
      <div class="k">${k}</div>
      <div class="v">${v}</div>
    </div>`).join('');
}

function makeChart(ctx, label, series, yKey, opts={}) {
  return new Chart(ctx, {
    type:'line',
    data:{
      labels: series.map(p => p.t),
      datasets:[{
        label, data: series.map(p => p[yKey]),
        tension:0.2, pointRadius:0, spanGaps:true
      }]
    },
    options:{
      parsing:false, animation:false,
      scales:{ x:{ type:'time', time:{ unit:'hour' }}, y:{ beginAtZero:false }},
      plugins:{ legend:{ display:true }},
      ...opts
    }
  });
}

function renderTable(series) {
  $tbody.innerHTML = series.slice(-1000).map(r => `
    <tr>
      <td style="text-align:left">${tlabel(r.t)}</td>
      <td>${fmtNum(r.outdoor_temp_c)}</td>
      <td>${r.outdoor_humidity_pct ?? '—'}</td>
      <td>${fmtNum(r.pressure_rel_hpa)}</td>
      <td>${fmtNum(r.pressure_abs_hpa)}</td>
      <td>${fmtNum(r.wind_speed_ms)}</td>
      <td>${fmtNum(r.wind_gust_ms)}</td>
      <td>${r.wind_dir_deg ?? '—'}</td>
      <td>${fmtNum(r.rain_rate_mm_hr)}</td>
      <td>${fmtNum(r.rain_hourly_mm)}</td>
      <td>${fmtNum(r.rain_daily_mm)}</td>
      <td>${fmtNum(r.solar_wm2)}</td>
      <td>${r.uv_index ?? '—'}</td>
    </tr>`).join('');
}

async function refresh() {
  try {
    $err.style.display='none';
    const hours = Number($win.value);
    $csv.href = `${ORIGIN}/api/export.csv?hours=${hours}`;

    const [latest, hist] = await Promise.all([
      api(`${ORIGIN}/api/latest`),
      api(`${ORIGIN}/api/history?hours=${hours}`)
    ]);

    renderCards(latest);
    renderTable(hist);

    if (cTemp) cTemp.destroy();
    if (cWind) cWind.destroy();
    if (cRain) cRain.destroy();

    cTemp = makeChart(document.getElementById('aw-chart-temp').getContext('2d'), 'Temp (°C)', hist, 'outdoor_temp_c');
    cWind = makeChart(document.getElementById('aw-chart-wind').getContext('2d'), 'Wind (m/s)',  hist, 'wind_speed_ms');
    cRain = makeChart(document.getElementById('aw-chart-rain').getContext('2d'), 'Rain rate (mm/h)', hist, 'rain_rate_mm_hr',
      { scales:{ y:{ beginAtZero:true } } });
  } catch (e) {
    $err.textContent = 'error: ' + e.message;
    $err.style.display='block';
  }
}

document.getElementById('aw-refresh').addEventListener('click', refresh);
document.getElementById('aw-window').addEventListener('change', refresh);
refresh();
setInterval(refresh, 60000); // refresh every minute
</script>
</body>
</html>
