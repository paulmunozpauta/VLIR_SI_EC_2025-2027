<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>andesaware – live weather</title>
  <meta http-equiv="Cache-Control" content="no-store" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --card: #f5f7fb; --text: #111827; --muted:#6b7280; --border:#e5e7eb; }
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; color: var(--text); }
    .wrap { max-width: 1100px; margin: 32px auto; padding: 0 16px; }
    h1 { font-size: 24px; margin: 0 0 8px 0; }
    .sub { color: var(--muted); margin-bottom: 20px; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(190px,1fr)); gap: 12px; }
    .card { background: var(--card); border: 1px solid var(--border); border-radius: 14px; padding: 14px; }
    .k { font-size: 12px; color: var(--muted); }
    .v { font-size: 26px; font-weight: 600; margin-top: 4px; }
    .row { display:flex; gap:10px; align-items:center; margin: 8px 0 0; color: var(--muted); font-size: 12px; }
    .error { color: #b91c1c; }
    .controls { display:flex; gap:10px; align-items:center; margin: 16px 0; }
    button, select { padding: 8px 10px; border: 1px solid var(--border); border-radius: 10px; background:#fff; cursor:pointer; }
    button:disabled { opacity:.6; cursor:not-allowed;}
    canvas { width:100%; height:320px; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>andesaware – live weather</h1>
    <div class="sub">real-time feed from your ecowitt station (si units)</div>

    <div id="status" class="row">loading…</div>

    <div class="grid" id="cards"></div>

    <div class="controls">
      <label for="hours">history window:</label>
      <select id="hours">
        <option value="6">6 h</option>
        <option value="12">12 h</option>
        <option value="24" selected>24 h</option>
        <option value="48">48 h</option>
        <option value="72">72 h</option>
      </select>
      <button id="refresh">refresh</button>
      <span id="updated" class="row"></span>
    </div>

    <canvas id="chart"></canvas>
  </div>

  <!-- chart.js + date adapter -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script>

  <script>
  const API = 'https://api.andesaware.com';
  const $status = document.getElementById('status');
  const $cards  = document.getElementById('cards');
  const $hours  = document.getElementById('hours');
  const $btn    = document.getElementById('refresh');
  const $updated= document.getElementById('updated');
  const ctx     = document.getElementById('chart').getContext('2d');
  let chart;

  const fmt = (x, unit) => (x==null || isNaN(x)) ? '—' : `${Number(x).toFixed(1)} ${unit}`;
  const asLocalTime = ts => new Date(ts).toLocaleString();

  async function getLatest() {
    const r = await fetch(`${API}/api/latest`, { cache:'no-store' });
    if (!r.ok) throw new Error(`latest ${r.status}`);
    return r.json();
  }
  async function getHistory(h) {
    const r = await fetch(`${API}/api/history?hours=${h}`, { cache:'no-store' });
    if (!r.ok) throw new Error(`history ${r.status}`);
    return r.json();
  }

  function renderCards(latest) {
    const d = latest?.data || {};
    const items = [
      ['Temperature', fmt(d.temp_c, '°C')],
      ['Humidity', d.rh!=null ? `${Number(d.rh)} %` : '—'],
      ['Pressure', fmt(d.pressure_hpa, 'hPa')],
      ['Wind', d.wind_ms!=null ? `${Number(d.wind_ms).toFixed(1)} m/s @ ${d.wind_dir_deg ?? '—'}°` : '—'],
      ['Rain rate', fmt(d.rain_mm_hr, 'mm/hr')],
      ['Solar', fmt(d.solar_wm2, 'W/m²')],
      ['UV index', d.uv!=null ? Number(d.uv).toFixed(1) : '—'],
    ];
    $cards.innerHTML = items.map(([k,v]) =>
      `<div class="card">
        <div class="k">${k}</div>
        <div class="v">${v}</div>
      </div>`).join('');
  }

  function renderChart(series){
    const labels = series.map(p => p.t);
    const temp   = series.map(p => p.temp_c);
    const wind   = series.map(p => p.wind_ms);
    const rain   = series.map(p => p.rain_mm_hr);

    if (chart) chart.destroy();
    chart = new Chart(ctx, {
      type: 'line',
      data: {
        labels,
        datasets: [
          { label: 'Temp (°C)',     data: temp, yAxisID: 'y1', tension: 0.25 },
          { label: 'Wind (m/s)',    data: wind, yAxisID: 'y2', tension: 0.25 },
          { label: 'Rain (mm/hr)',  data: rain, yAxisID: 'y3', tension: 0.25 }
        ]
      },
      options: {
        responsive: true,
        parsing: false,
        interaction: { mode: 'index', intersect: false },
        scales: {
          x: { type: 'time', time: { tooltipFormat: 'Pp' } },
          y1: { type: 'linear', position: 'left' },
          y2: { type: 'linear', position: 'right', grid: { drawOnChartArea: false } },
          y3: { type: 'linear', position: 'right', grid: { drawOnChartArea: false }, display: false }
        },
        plugins: {
          tooltip: {
            callbacks: {
              title: (items) => asLocalTime(items[0].parsed.x)
            }
          }
        }
      }
    });
  }

  async function refresh(){
    try {
      $status.textContent = 'loading…';
      $btn.disabled = true;
      const [latest, hist] = await Promise.all([getLatest(), getHistory($hours.value)]);
      renderCards(latest);
      renderChart(hist);
      $status.textContent = 'live';
      const when = latest?.ts ? asLocalTime(latest.ts) : '—';
      $updated.textContent = `last update: ${when}`;
    } catch (e) {
      $status.innerHTML = `<span class="error">error: ${e.message}</span>`;
    } finally {
      $btn.disabled = false;
    }
  }

  $btn.addEventListener('click', refresh);
  $hours.addEventListener('change', refresh);

  // first load + auto-refresh every 15 s
  refresh();
  setInterval(refresh, 15000);
  </script>
</body>
</html>
