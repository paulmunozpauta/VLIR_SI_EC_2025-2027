<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weather Station in Chile - Universidad de Concepción, campus Chillán</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root { 
            font-family: system-ui, sans-serif; 
            line-height: 1.35; 
        }
        
        body { 
            margin: 0;
            padding: 0;
            color: #333;
        }
        
        /* Navigation placeholder */
        #nav-placeholder {
            background-color: #2c3e50;
            color: white;
            padding: 1rem;
        }
        
        /* Hero banner */
        .image-banner {
            position: relative;
            height: 200px;
            background-size: cover;
            background-position: center;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .text-overlay {
            color: white;
            font-size: 2.5rem;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        
        /* Main content */
        main {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        /* Weather data styles */
        .grid { 
            display: grid; 
            grid-template-columns: 14rem 1fr; 
            gap: .35rem .75rem; 
            margin: 1.5rem 0;
        }
        
        .k { color: #444; }
        .v { font-variant-numeric: tabular-nums; }
        .muted { color:#666; font-size:.9rem; margin-top:.75rem }
        .ok { color:#2c7; } 
        .err{ color:#c33; }
        
        /* Map section styles */
        .map-section {
            margin-top: 2rem;
            border-top: 1px solid #e0e0e0;
            padding-top: 1.5rem;
        }
        
        .map-section h2 {
            margin-bottom: 1rem;
            color: #333;
        }
        
        #station-map {
            height: 300px;
            width: 100%;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 1rem;
        }
        
        .coordinates {
            text-align: center;
            font-family: monospace;
            color: #666;
            font-size: 0.9rem;
        }
        
        /* Historical data table styles */
        .historical-section {
            margin-top: 2.5rem;
            border-top: 1px solid #e0e0e0;
            padding-top: 1.5rem;
        }
        
        .historical-section h2 {
            margin-bottom: 1rem;
            color: #333;
        }
        
        .table-container {
            overflow-x: auto;
            margin-bottom: 1rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background-color: white;
        }
        
        thead {
            background-color: #4b6cb7;
            color: white;
        }
        
        th, td {
            padding: 10px 12px;
            text-align: left;
            border-bottom: 1px solid #e1e1e1;
            white-space: nowrap;
        }
        
        tbody tr:hover {
            background-color: #f1f5fd;
        }
        
        .timestamp {
            min-width: 180px;
        }
        
        /* Footer placeholder */
        #footer-placeholder {
            background-color: #f5f5f5;
            padding: 2rem;
            text-align: center;
            margin-top: 3rem;
            border-top: 1px solid #e0e0e0;
        }
        
        @media (max-width: 768px) {
            main {
                padding: 1rem;
            }
            
            table {
                font-size: 0.85rem;
            }
            
            th, td {
                padding: 8px 10px;
            }
            
            #station-map {
                height: 250px;
            }
            
            .grid {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation will be inserted here -->
    <div id="nav-placeholder"></div>
    
    <div class="image-banner hero-small" style="background-image: url('images/background.jpg');">
        <div class="text-overlay">Weather data</div>
    </div>

    <!-- Content -->
    <main>
        <h1>AW005: Kessel-Lo</h1>
        <div id="status" class="muted">loading…</div>
        <dl class="grid" id="out"></dl>

        <!-- Station Location Map Section -->
        <div class="map-section">
            <h2>Location</h2>
            <div id="station-map"></div>
            <div class="coordinates">Coordinates: -36.595426, -72.081531</div>
        </div>

        <!-- Historical Data Section -->
        <div class="historical-section">
            <h2>Historical data</h2>
            <div class="table-container">
                <table id="weather-table">
                    <thead>
                        <tr>
                            <th>Timestamp</th>
                            <th>Temp (°C)</th>
                            <th>Humidity (%)</th>
                            <th>Dew Point (°C)</th>
                            <th>Feels Like (°C)</th>
                            <th>Wind Speed (km/h)</th>
                            <th>Wind Gust (km/h)</th>
                            <th>Pressure (hPa)</th>
                            <th>Rain Rate (mm/hr)</th>
                            <th>Rain Today (mm)</th>
                            <th>Solar (W/m²)</th>
                            <th>UV Index</th>
                            <th>Indoor Temp (°C)</th>
                            <th>Indoor Humidity (%)</th>
                        </tr>
                    </thead>
                    <tbody id="table-body">
                        <!-- Data will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>
            <div class="muted" id="table-info">Loading historical data from GitHub...</div>
        </div>
    </main>
    
    <!-- Footer will be inserted here -->
    <div id="footer-placeholder"></div>

    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        const ENDPOINT = "https://api.andesaware.com/weatherstation/sensor/AW005";
        const REFRESH_MS = 300000;

        // Use the correct raw GitHub URL format
        const CSV_URL = "https://raw.githubusercontent.com/paulmunozpauta/VLIR_SI_EC_2025-2027/main/datasets/AW005.csv";

        // Station coordinates
        const STATION_COORDS = [50.90241987188318, 4.720330533578788];

        // CORRECTED CONVERSION FUNCTIONS
        function cToF(c){ return (c * 9/5) + 32; }  // Fixed: Celsius to Fahrenheit
        function kmhToMph(km){ return km * 0.621371; }
        function hpaToInHg(h){ return h * 0.02953; }
        function mmToIn(mm){ return mm * 0.0393701; }

        function row(k, v){ return `<dt class="k">${k}</dt><dd class="v">${v}</dd>`; }

        async function load(){
            const status = document.getElementById('status');
            try {
                const res = await fetch(ENDPOINT, { cache: 'no-store' });
                if (!res.ok) throw new Error(`http ${res.status}`);
                const data = await res.json();
                const ecowitt = data.ecowitt_api || {};
                
                // Extract values from Ecowitt API structure
                const outdoor = ecowitt.outdoor || {};
                const wind = ecowitt.wind || {};
                const pressure = ecowitt.pressure || {};
                const rainfall = ecowitt.rainfall || {};
                const solar_uvi = ecowitt.solar_and_uvi || {};

                // Get values with fallbacks - VALUES ARE IN CELSIUS FROM JSON
                const tempC = outdoor.temperature?.value;
                const humid = outdoor.humidity?.value;
                const dewC = outdoor.dew_point?.value;
                const windKmh = wind.wind_speed?.value;
                const gustKmh = wind.wind_gust?.value;
                const wdir = wind.wind_direction?.value;
                const pressInHg = pressure.relative?.value;
                const pressHpa = pressInHg ? inHgToHpa(parseFloat(pressInHg)).toFixed(1) : '—';
                const rainMm = rainfall.rain_rate?.value;
                const dayRainMm = rainfall.daily?.value;
                const solar = solar_uvi.solar?.value;
                const uv = solar_uvi.uvi?.value;

                // FIXED DISPLAY LOGIC - Show Celsius first, then Fahrenheit conversion
                const rows = [
                    row('temperature', `${tempC ?? '—'} °C (${tempC ? cToF(parseFloat(tempC)).toFixed(1) : '—'} °F)`),
                    row('feels like', `${outdoor.feels_like?.value ?? '—'} °C (${outdoor.feels_like?.value ? cToF(parseFloat(outdoor.feels_like.value)).toFixed(1) : '—'} °F)`),
                    row('humidity', `${humid ?? '—'} %`),
                    row('dew point', `${dewC ?? '—'} °C (${dewC ? cToF(parseFloat(dewC)).toFixed(1) : '—'} °F)`),
                    row('wind', `${windKmh ?? '—'} km/h (${windKmh ? kmhToMph(parseFloat(windKmh)).toFixed(1) : '—'} mph) dir ${wdir ?? '—'}°`),
                    row('gust', `${gustKmh ?? '—'} km/h (${gustKmh ? kmhToMph(parseFloat(gustKmh)).toFixed(1) : '—'} mph)`),
                    row('pressure', `${pressHpa} hPa (${pressInHg ?? '—'} inHg)`),
                    row('rain rate', `${rainMm ?? '—'} mm/hr (${rainMm ? mmToIn(parseFloat(rainMm)).toFixed(2) : '—'} in/hr)`),
                    row('rain today', `${dayRainMm ?? '—'} mm (${dayRainMm ? mmToIn(parseFloat(dayRainMm)).toFixed(1) : '—'} in)`),
                    row('solar', `${solar ?? '—'} W/m²`),
                    row('uv index', uv ?? '—'),
                    row('last update', data.received_at ? new Date(data.received_at).toLocaleString() : '—'),
                ];

                // Add indoor data if available
                if (ecowitt.indoor) {
                    const indoorTempC = ecowitt.indoor.temperature?.value;
                    rows.splice(3, 0, row('indoor temp', `${indoorTempC ?? '—'} °C (${indoorTempC ? cToF(parseFloat(indoorTempC)).toFixed(1) : '—'} °F)`));
                    rows.splice(4, 0, row('indoor humidity', `${ecowitt.indoor.humidity?.value ?? '—'} %`));
                }

                document.getElementById('out').innerHTML = rows.join('');
                status.textContent = `updated ${new Date().toLocaleTimeString()} • refresh ${REFRESH_MS/1000}s`;
                status.className = "muted ok";
            } catch (e) {
                document.getElementById('status').textContent = `failed to load (${e.message}). retrying…`;
                document.getElementById('status').className = "muted err";
            }
        }

        // ADD MISSING CONVERSION FUNCTIONS
        function inHgToHpa(i){ return i * 33.8638866667; }
        function mphToKmh(m){ return m * 1.60934; }

        // Initialize the map
        function initMap() {
            const map = L.map('station-map').setView(STATION_COORDS, 15);
            
            // Add OpenStreetMap tiles
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);
            
            // Add a marker for the weather station
            const stationMarker = L.marker(STATION_COORDS).addTo(map)
                .bindPopup('Weather Station Location<br>Kessel-Lo, Belgium')
                .openPopup();
            
            // Add a circle to highlight the location
            L.circle(STATION_COORDS, {
                color: '#4b6cb7',
                fillColor: '#4b6cb7',
                fillOpacity: 0.1,
                radius: 100
            }).addTo(map);
        }

        // FIXED CSV PARSING - Add headers if not present
        function parseCSV(csvText) {
            const lines = csvText.split('\n').filter(line => line.trim());
            
            // Define headers based on your CSV structure
            const headers = [
                'timestamp', 'temperature_c', 'humidity_pct', 'dew_point_c', 'feels_like_c',
                'wind_speed_kmh', 'wind_gust_kmh', 'wind_direction_deg', 'pressure_inhg',
                'rain_rate_mmhr', 'rain_daily_mm', 'solar_wm2', 'uvi',
                'indoor_temp_c', 'indoor_humidity_pct'
            ];
            
            const data = [];
            
            // Check if first line contains headers or data
            const firstLine = lines[0].split(',');
            const hasHeaders = isNaN(parseFloat(firstLine[1])); // Check if second column is numeric
            
            let startIndex = 0;
            if (hasHeaders) {
                // Use existing headers if present
                startIndex = 1;
            }
            
            for (let i = startIndex; i < lines.length; i++) {
                if (!lines[i].trim()) continue;
                
                const values = lines[i].split(',').map(v => v.trim());
                const row = {};
                
                headers.forEach((header, index) => {
                    if (index < values.length) {
                        let value = values[index];
                        
                        // Convert numeric values
                        if (header !== 'timestamp' && value && !isNaN(value) && value.trim() !== '') {
                            value = parseFloat(value);
                        }
                        
                        row[header] = value;
                    } else {
                        row[header] = '';
                    }
                });
                
                data.push(row);
            }
            
            return data;
        }

        // Format timestamp for display
        function formatTimestamp(timestamp) {
            if (!timestamp) return 'Invalid Date';
            try {
                const date = new Date(timestamp);
                return isNaN(date.getTime()) ? 'Invalid Date' : date.toLocaleString();
            } catch (e) {
                return 'Invalid Date';
            }
        }

        // FIXED TABLE POPULATION - Use the correct column names
        function populateTable(data) {
            const tableBody = document.getElementById('table-body');
            const tableInfo = document.getElementById('table-info');
            
            tableBody.innerHTML = '';
            
            if (!data || data.length === 0) {
                tableInfo.textContent = 'No historical data available';
                return;
            }
            
            // Show only last 60 records (most recent first)
            const displayData = data.slice(-60).reverse();
            
            displayData.forEach(row => {
                const tr = document.createElement('tr');
                
                tr.innerHTML = `
                    <td class="timestamp">${formatTimestamp(row.timestamp)}</td>
                    <td>${row.temperature_c !== undefined ? row.temperature_c : '—'}</td>
                    <td>${row.humidity_pct !== undefined ? row.humidity_pct : '—'}</td>
                    <td>${row.dew_point_c !== undefined ? row.dew_point_c : '—'}</td>
                    <td>${row.feels_like_c !== undefined ? row.feels_like_c : '—'}</td>
                    <td>${row.wind_speed_kmh !== undefined ? row.wind_speed_kmh : '—'}</td>
                    <td>${row.wind_gust_kmh !== undefined ? row.wind_gust_kmh : '—'}</td>
                    <td>${row.pressure_inhg !== undefined ? inHgToHpa(parseFloat(row.pressure_inhg)).toFixed(1) : '—'}</td>
                    <td>${row.rain_rate_mmhr !== undefined ? row.rain_rate_mmhr : '—'}</td>
                    <td>${row.rain_daily_mm !== undefined ? row.rain_daily_mm : '—'}</td>
                    <td>${row.solar_wm2 !== undefined ? row.solar_wm2 : '—'}</td>
                    <td>${row.uvi !== undefined ? row.uvi : '—'}</td>
                    <td>${row.indoor_temp_c !== undefined ? row.indoor_temp_c : '—'}</td>
                    <td>${row.indoor_humidity_pct !== undefined ? row.indoor_humidity_pct : '—'}</td>
                `;
                
                tableBody.appendChild(tr);
            });
            
            tableInfo.textContent = `✓ Loaded ${data.length} records (showing last ${displayData.length})`;
        }

        // Fetch CSV data from GitHub
        async function loadCSVData() {
            try {
                const tableInfo = document.getElementById('table-info');
                tableInfo.textContent = 'Fetching data from GitHub...';
                
                const response = await fetch(CSV_URL);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const csvText = await response.text();
                console.log('Raw CSV data:', csvText); // Debug log
                
                const csvData = parseCSV(csvText);
                console.log('Parsed CSV data:', csvData); // Debug log
                
                populateTable(csvData);
                
            } catch (error) {
                console.error('Error loading CSV:', error);
                document.getElementById('table-info').textContent = `Error loading data: ${error.message}`;
                document.getElementById('table-info').className = "muted err";
            }
        }

        // Components auto-loaded
        async function loadComponents() {
            try {
                const res = await fetch('components.html');
                const text = await res.text();

                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = text;

                const logoBar = tempDiv.querySelector('#logo-bar');
                if (logoBar) {
                    document.body.insertBefore(logoBar, document.body.firstChild);
                }

                const nav = tempDiv.querySelector('#shared-nav');
                if (nav) {
                    const navPlaceholder = document.getElementById('nav-placeholder');
                    navPlaceholder.parentNode.replaceChild(nav, navPlaceholder);
                }

                const footer = tempDiv.querySelector('#shared-footer');
                if (footer) {
                    const footerPlaceholder = document.getElementById('footer-placeholder');
                    footerPlaceholder.parentNode.replaceChild(footer, footerPlaceholder);
                }
            } catch (error) {
                console.error('Error loading components:', error);
                // Fallback navigation if components.html is not available
                document.getElementById('nav-placeholder').innerHTML = `
                    <nav style="padding: 1rem; background: #2c3e50; color: white;">
                        <a href="/" style="color: white; text-decoration: none; font-weight: bold;">Home</a> | 
                        <a href="/weather.html" style="color: white; text-decoration: none;">Weather Station</a>
                    </nav>
                `;
                
                document.getElementById('footer-placeholder').innerHTML = `
                    <footer style="text-align: center; padding: 2rem; background: #f5f5f5;">
                        <p>Weather Station Data - Kessel-Lo</p>
                    </footer>
                `;
            }
        }

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            // Load navigation and footer components
            loadComponents();
            
            // Load current weather data
            load();
            setInterval(load, REFRESH_MS);
            
            // Initialize the map
            initMap();
            
            // Load historical CSV data from GitHub
            loadCSVData();
        });
    </script>
</body>
</html>